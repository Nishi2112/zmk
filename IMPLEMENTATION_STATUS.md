# Snugon MO1 実装状況レポート

## 概要
このドキュメントは、ZMKベースのSnugon MO1ワイヤレスゲーミングマウスの実装状況、未実装機能、および既知の問題点をまとめたものです。

実装日: 2024年12月
ボード: Seeed XIAO nRF52840 (seeeduino_xiao_ble)
ファームウェア: ZMK (Zephyr RTOS ベース)

## 実装完了項目

### 1. 基本インフラストラクチャ ✅
- **ボード定義ファイル**: `/app/boards/shields/snugon_mo1/` に作成
  - `Kconfig.shield`: シールド定義
  - `Kconfig.defconfig`: デフォルト設定
  - `snugon_mo1.conf`: 詳細設定
  - `snugon_mo1.overlay`: ハードウェア定義
  - `snugon_mo1.keymap`: キーマップ定義
  - `snugon_mo1.zmk.yml`: メタデータ
  - `boards/seeeduino_xiao_ble.overlay`: ボード固有のピン定義

### 2. ハードウェア統合 ✅
- **PMW3610光学センサー**
  - 外部ドライバーモジュール統合完了（inorichi/zmk-pmw3610-driver）
  - SPI通信設定（2MHz、CS: D7、IRQ: D3）
  - `pixart`ベンダープレフィックス追加済み

- **MCP23017 I2Cエクスパンダー**
  - 16ピンGPIOエクスパンダー設定完了
  - I2Cアドレス: 0x20
  - 4x4マトリックス構成（12ボタン + 予備）

- **ホイールエンコーダー**
  - Alps EC11互換エンコーダー設定
  - ピン: D0 (A相)、D1 (B相)
  - スクロール機能実装済み

- **バッテリー監視**
  - 電圧分圧回路設定（A0ピン使用）
  - バッテリーレポート機能有効化

### 3. ソフトウェア機能 ✅
- **USB/Bluetooth切り替え**: 両方サポート
- **32レイヤーサポート**: ZMKデフォルトで対応
- **基本的なマウス機能**: 左/右/中クリック、スクロール
- **省電力機能**: アイドル/スリープタイムアウト設定

### 4. 最適化 ✅
- **フラッシュ使用量削減**: 93.33% → 76.89%
  - サイズ最適化フラグ有効化
  - 不要な機能の無効化
  - スタックサイズの調整

### 5. ピン配置の修正 ✅
- **RGB LED**: D2からD6へ移動（D2とA0の物理的競合を回避）

## 未実装/制限事項

### 1. RGB LED機能 ⚠️
- **現状**: 設定は準備されているが無効化中
- **理由**: ZMKのRGB LEDサポートが主にWS2812ストリップ向けで、単一LEDのバッテリーステータス表示には適していない
- **必要な作業**: カスタムバッテリーLEDドライバーの実装

### 2. DPI制御 ⚠️
- **現状**: プレースホルダー実装（F13/F14/F15キーを送信）
- **理由**: PMW3610ドライバーにDPI変更APIが未実装
- **必要な作業**: 
  - PMW3610ドライバーへのDPI制御機能追加
  - ZMKビヘイビアとドライバーの連携実装

### 3. レイヤー切り替え機能 ⚠️
- **現状**: デフォルトレイヤーのみ実装
- **理由**: 物理的なレイヤー切り替えボタンの割り当てが未定
- **必要な作業**: キーマップでのレイヤー切り替えビヘイビア追加

## 既知の問題点

### 1. ハードウェア制約
- **ピン不足**: XIAO nRF52840の利用可能なピンをほぼすべて使用
- **拡張性**: 追加機能の実装が困難

### 2. ソフトウェア制限
- **DPIフィードバック**: 現在のDPI設定を確認する方法がない
- **バッテリーステータス**: LED表示なしでは視覚的確認が不可能

### 3. テスト未実施
- **実機テスト**: ハードウェアでの動作確認が必要
- **電力消費**: 実際のバッテリー持続時間が未検証
- **Bluetooth接続**: ペアリング、再接続、マルチデバイス切り替えのテストが必要

## 推奨される次のステップ

1. **実機での基本動作確認**
   - USB接続での動作確認
   - ボタン、ホイール、センサーの反応テスト

2. **Bluetooth機能のテスト**
   - ペアリング手順の確立
   - 接続安定性の確認

3. **カスタムバッテリーLEDドライバーの開発**
   - シンプルなGPIO制御によるLED点滅パターン実装

4. **DPI制御の実装**
   - PMW3610ドライバーの機能拡張
   - ユーザーフレンドリーなDPI切り替え方法の実装

5. **キーマップのカスタマイズ**
   - ゲーミング向けの実用的なレイヤー設定
   - マクロ機能の活用

## ビルド情報

```
ビルドコマンド: west build -s app -b seeeduino_xiao_ble -- -DSHIELD=snugon_mo1
フラッシュ使用量: 394,568 bytes (76.89%)
RAM使用量: 140,024 bytes (55.41%)
出力ファイル: build/zephyr/zmk.uf2
```

## 参考リンク

- [仕様書](spec.md)
- [ZMKドキュメント](https://zmk.dev/)
- [PMW3610ドライバー](https://github.com/inorichi/zmk-pmw3610-driver)